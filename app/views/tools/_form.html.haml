= simple_form_for @tool, html: { data: { bind: "with: tool" } } do |f|
  = f.error_notification

  %div.form-inputs
    %fieldset
      %div.row
        %span.span2
          %p.help-block Please describe the instrument you'd like to share.
        %span.span10
          %legend About the tool
          %div.row
            %span.span8
              = f.input :tool_category_name, required: true, wrapper: :append do
                = f.input_field :tool_category_name, autocomplete: "off", data: { provide: "typeahead", bind: "typeahead: tool_category_name", lookup: typeahead_path(:tool_category) }
                %button.btn
                  %i.icon-angle-down

          %div.row
            %span.span3
              = f.input :manufacturer_name, required: true, wrapper: :append do
                = f.input_field :manufacturer_name, autocomplete: "off", data: { provide: "typeahead", bind: "typeahead: manufacturer_name", lookup: typeahead_path(:manufacturer) }
                %button.btn
                  %i.icon-angle-down

            %span.span3
              = f.input :model_name, required: true, input_html: { autocomplete: "off", data: { bind: "typeahead: model_name", lookup: typeahead_path(:model) } }

            %span.span2
              = f.input :year_manufactured, as: :select, collection: @tool.possible_years, prompt: "Unknown", include_blank: true

          %div.row
            %span.span8
              = f.input :description

      %div.row
        %span.span2
          %p.help-block If possible, please indicate the sample size and resolution of the tool.

        %span.span10
          %div.row
            %span.span5= f.input :resolution, input_html: { min: 0, type: "number", step: "any" }
            %span.span3= f.input :resolution_unit_id, as: :select, collection: AvailableUnit.all, value_method: :name, label_method: :display_name

          %div.row
            %span.span5
              %div.control-group.optional.tool_sample_size
                %label.optional.control-label{for: "tool_sample_size"} Sample size

                %div.controls
                  = f.hidden_field :sample_size_min, data: { bind: "value: sampleSize.min" }
                  = f.hidden_field :sample_size_max, data: { bind: "value: sampleSize.max" }
                  %div.slider-input{data: { bind: "slider: sampleSize" }}
                  %p.help-block{style: "margin-top: 10px"}
                    %span.exponent
                      10
                      %sup{data: { bind: "text: sampleSize.min"} }
                      %span.unit{data: { bind: "text: sampleSize.unitName" } }
                    \ -
                    %span.exponent
                      10
                      %sup{data: { bind: "text: sampleSize.max"} }
                      %span.unit{data: { bind: "text: sampleSize.unitName" } }


            %span.span3
              = f.input :sample_size_unit_id, as: :select, collection: AvailableUnit.all, value_method: :name, label_method: :display_name, wrapper_html: { class: "tool_sample_size_unit" }, input_html: { data: { bind: "value: sampleSize.unit.writeable" } }


    %fieldset

      %div.row
        %span.span2
          %p.help-block The pricing structure for your tool. If you need help determining what the right values should be, please get in touch.
        %span.span8
          %legend Pricing
          %div.row{style: "margin-bottom: 10px"}
            %span.span2
              %label.radio
                = f.radio_button :currency, "USD", data: { bind: "checked: currency" }
                USD ($)
            %span.span2
              %label.radio
                = f.radio_button :currency, "GBP", data: { bind: "checked: currency" }
                GBP (Â£)

          %div.row
            %span.span3
              = f.input :base_lead_time, input_html: { min: 1 }
            %span.span4
              = f.input :base_price, wrapper: "prepend" do
                = content_tag :span, "", class: "add-on currency", data: { bind: "text: currencySymbol" }
                = f.input_field :base_price, min: 0, type: "number", step: "any"
          %div.row
            %span.span8
              = f.input :can_expedite, label: false, inline_label: raw("Offer expedited pricing? " + content_tag(:span, "Recommended", class: "label label-info")), input_html: { "data-bind" => "checked: can_expedite" }
          %div.row
            %span.span3
              = f.input :expedited_lead_time, input_html: { min: 1, "data-bind" => "enable: can_expedite" }
            %span.span4
              = f.input :expedited_price, wrapper: "prepend" do
                = content_tag :span, "", class: "add-on currency", data: { bind: "text: currencySymbol" }
                = f.input_field :expedited_price, min: 0, type: "number", step: "any", data: { bind: "enable: can_expedite" }


    %fieldset
      %div.row
        %span.span2
          %p.help-block We keep this information hidden from users until they've confirmed a reservation with you.
        %span.span8
          %legend
            %a.tip{href: "#", title: t('data.private'), data: { toggle: "tooltip" }}
              %i.icon-lock.icon-large
            Facility
          = f.input :facility, as: :select, collection: current_user.facilities, label_method: :title, include_blank: "Create a new facility", input_html: { "data-bind" => "value: facility_id" }
          %div.facility{data: { bind: "visible: showFacility" }}
            = f.simple_fields_for :facility, Facility.new do |fa|
              = fa.input :name
              = fa.simple_fields_for :address, fa.object.build_address do |a|
                = a.hidden_field :id
                = render partial: 'addresses/form', object: a

      - unless @tool.new_record?
        = f.simple_fields_for :file_attachments_attributes, index: nil do |i|
          %fieldset
            %div.row
              %span.span2
                %p.help-block Add a picture or two.
              %span.span8
                %legend
                  %i.icon-picture.icon-large
                  Images
                %ul.unstyled.file-list{data: { bind: "sortable: images" }}
                  %li
                    %a.destroy{data: { bind: "click: $parent.removeFile" } }
                      %i.icon-remove-sign
                    %img{data: { bind: "attr: { src: thumbnail }" }}
                    = i.hidden_field :id,       data: { bind: "value: id" }
                    = i.hidden_field :file_id,  data: { bind: "value: file_id" }
                    = i.hidden_field :position, data: { bind: "value: $index" }
                    = i.hidden_field :_destroy, class: "destroyed", data: { bind: "value: $data._destroy" }
                    = i.hidden_field :category, value: FileAttachment::Categories::IMAGE
                %ul.unstyled.file-list
                  %li
                    %a.add-file{data: { bind: "click: addFile", upload: files_path }}
                      %i.icon-plus-sign

  %div.row
    %span.offset2.span8
      = f.button :submit, class: "btn btn-primary"
      = link_to "Cancel", profile_path, class: "btn btn-default"

:javascript
  $(function() {
    window.tool = new Tool(#{@tool.to_json});
    ko.applyBindings({ tool: tool });
  });

