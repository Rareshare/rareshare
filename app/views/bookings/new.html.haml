- nav_category @booking.owner?(current_user) ? "Share a Tool" : "Find a Tool"

= link_to tool_path(@booking.tool) do
  %i.icon.icon-angle-left
  Cancel

= simple_form_for @booking, html: { "data-bind" => "with: booking" } do |f|
  %div.form-inputs
    = f.input :tool_id, as: :hidden
    = f.input :deadline, as: :hidden
    %fieldset
      %legend Request a Booking
      %div.row
        %span.span2
        %span.span8
          %p
            Request to book
            = link_to @booking.tool.display_name, tool_path(@booking.tool)
            to process a sample on or before #{@booking.deadline.to_date.to_s(:long)}.
            The total cost for this reservation will be #{number_to_currency @booking.price}.

      %div.row.step{ "data-bind" => "css: { complete: stepOneComplete }"}
        %span.span2
          %h1 1
          %small
            Describe your intended usage of the tool.
        %span.span8
          = f.input :sample_description, input_html: { "data-bind" => "wysihtml5: sample_description" }

      %div.row.step{ "data-bind" => "css: { complete: stepTwoComplete }"}
        %span.span12.border
        %span.span2
          %h1 2
          %small Describe the outcome you would like.
        %span.span8
          = f.input :sample_deliverable, input_html: { "data-bind" => "wysihtml5: sample_deliverable" }

      %div.row.step{ "data-bind" => "css: { complete: stepThreeComplete }"}
        %span.span12.border
        %span.span2
          %h1 3
          %small How would you like the tool owner to receive your sample?
        %span.span8
          = f.input :sample_transit, as: :select, collection: Booking::Transit::ALL.map {|k| [ t("bookings.transit.#{k}"), k ]}, input_html: { "data-bind" => "value: sample_transit" }

          %div.transit.in_person{ "data-bind" => "visible: sample_transit() == 'in_person'" }
            %p We'll let you know the address of the tool when the owner approves the booking.

          %div.transit.rareshare_send{ "data-bind" => "visible: sample_transit() == 'rareshare_send'" }
            %p Please let us know where you'd like us to send the packaging materials.
            - if current_user.address.present?
              %label.radio
                %input{type: "radio", name: "booking[address_id]", value: current_user.address.id, checked: @booking.address_id.present?, "data-bind" => "checked: address_id.writeable"}
                Use my address (#{current_user.address.full_street_address})

              %label.radio
                %input{type: "radio", name: "booking[address_id]", value: nil, checked: @booking.address_id.blank?, "data-bind" => "checked: address_id.writeable"}
                Add a new shipping address

            %div.row.address
              %div.span8.slide-down{"data-bind" => "css: { slid: needsAddress }"}
                = f.simple_fields_for :address do |a|
                  = render partial: 'addresses/form', object: a

          %div.transit.renter_send{ "data-bind" => "visible: sample_transit() == 'renter_send'" }
            %p We'll let you know the address of the tool when the owner approves the booking.

          %div.transit.digital_send{ "data-bind" => "visible: sample_transit() == 'digital_send'" }
            %p You'll have to come to a separate arrangement with the owner of the tool over data transfer.

          %div.transit.none_required{ "data-bind" => "visible: sample_transit() == 'none_required'" }

      %div.row.step{ "data-bind" => "css: { complete: stepFourComplete }"}
        %span.span12.border
        %span.span2
          %h1 4
          %small Read the terms and conditions.
        %span.span8
          %div.terms_and_conditions
            = sanitize Page.where(title: "Terms & Conditions").first.try(:content)

          = f.input :tos_accepted, label: false, input_html: { class: "primary", "data-bind" => "checked: tos_accepted" }, inline_label: t('simple_form.labels.booking.tos_accepted', terms_link: page_link_to('Terms & Conditions', target: "_blank")).html_safe

    %div.row
      %span.offset2.span10
        = f.submit "Reserve", class: "btn btn-primary"
        = link_to "Cancel", :back, class: "btn"

  :javascript
    $(function() {
      window.booking = new Booking(#{@booking.to_json});
      ko.applyBindings({ booking: booking });
    });
